import { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInWithCustomToken, onAuthStateChanged, signInAnonymously } from 'firebase/auth';
import { getFirestore, collection, addDoc, onSnapshot, query, orderBy } from 'firebase/firestore';

// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã®å®šç¾©
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// Firebaseã‚¢ãƒ—ãƒªã®åˆæœŸåŒ–
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
const App = () => {
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  const [password, setPassword] = useState('');
  const [noteContent, setNoteContent] = useState('');
  const [notes, setNotes] = useState([]);
  const [userId, setUserId] = useState(null);
  const [message, setMessage] = useState('');
  const correctPassword = "John2";

  // ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒãƒã‚¦ãƒ³ãƒˆã•ã‚ŒãŸã¨ãã«èªè¨¼ãƒ—ãƒ­ã‚»ã‚¹ã‚’é–‹å§‹
  useEffect(() => {
    const authenticate = async () => {
      try {
        if (initialAuthToken) {
          await signInWithCustomToken(auth, initialAuthToken);
        } else {
          await signInAnonymously(auth);
        }
      } catch (error) {
        console.error("Firebase authentication error:", error);
      }
    };
    authenticate();
  }, []);

  // èªè¨¼çŠ¶æ…‹ã®å¤‰æ›´ã‚’ç›£è¦–
  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, (user) => {
      if (user) {
        setIsAuthenticated(true);
        setUserId(user.uid);
      } else {
        setIsAuthenticated(false);
        setUserId(null);
      }
    });
    return () => unsubscribe();
  }, []);

  // ãƒãƒ¼ãƒˆã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§å–å¾—
  useEffect(() => {
    if (isAuthenticated && userId) {
      const notesCollectionPath = `/artifacts/${appId}/public/data/notes`;
      const q = query(collection(db, notesCollectionPath));
      
      const unsubscribe = onSnapshot(q, (snapshot) => {
        const fetchedNotes = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        // æ—¥ä»˜ã§é™é †ã«ã‚½ãƒ¼ãƒˆ
        fetchedNotes.sort((a, b) => b.timestamp - a.timestamp);
        setNotes(fetchedNotes);
      }, (error) => {
        console.error("Error fetching notes:", error);
      });
      return () => unsubscribe();
    }
  }, [isAuthenticated, userId]);

  // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ã¨ãƒãƒ¼ãƒˆã®è¿½åŠ 
  const handleAddNote = async (e) => {
    e.preventDefault();
    if (password !== correctPassword) {
      setMessage('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™ã€‚');
      return;
    }
    if (noteContent.trim() === '') {
      setMessage('ãƒãƒ¼ãƒˆã®å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
      return;
    }

    try {
      const notesCollectionPath = `/artifacts/${appId}/public/data/notes`;
      await addDoc(collection(db, notesCollectionPath), {
        content: noteContent,
        timestamp: Date.now(),
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¯å…¬é–‹ãƒ‡ãƒ¼ã‚¿ãªã®ã§è¨˜éŒ²ã—ãªã„ãŒã€èªè¨¼ã®ãŸã‚ã«å¿…è¦
      });
      setNoteContent('');
      setPassword('');
      setMessage('ãƒãƒ¼ãƒˆãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸï¼');
    } catch (e) {
      console.error("Error adding document: ", e);
      setMessage('ãƒãƒ¼ãƒˆã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
    }
  };

  return (
    <div className="min-h-screen bg-slate-900 text-white font-sans p-4 flex flex-col items-center">
      <div className="w-full max-w-2xl bg-slate-800 p-8 rounded-2xl shadow-xl space-y-8">
        <h1 className="text-4xl font-bold text-center text-orange-400">
          ã¿ã‚“ãªã®å…±æœ‰ãƒãƒ¼ãƒˆ ğŸ“
        </h1>
        <p className="text-center text-slate-400">
          ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ã€æ–°ã—ã„ãƒãƒ¼ãƒˆã‚’è¿½åŠ ã—ã¾ã—ã‚‡ã†ã€‚
        </p>

        <form onSubmit={handleAddNote} className="space-y-4">
          <input
            type="password"
            className="w-full p-3 rounded-xl bg-slate-700 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-orange-500"
            placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"
            value={password}
            onChange={(e) => setPassword(e.target.value)}
          />
          <textarea
            className="w-full h-32 p-3 rounded-xl bg-slate-700 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-orange-500"
            placeholder="ãƒãƒ¼ãƒˆã®å†…å®¹ã‚’ã“ã“ã«å…¥åŠ›ã—ã¦ãã ã•ã„"
            value={noteContent}
            onChange={(e) => setNoteContent(e.target.value)}
          ></textarea>
          <button
            type="submit"
            className="w-full p-3 rounded-xl bg-orange-500 text-white font-bold hover:bg-orange-600 transition-colors duration-200 shadow-lg"
          >
            ãƒãƒ¼ãƒˆã‚’è¿½åŠ 
          </button>
        </form>

        {message && (
          <div className="text-center text-sm font-semibold text-orange-400">
            {message}
          </div>
        )}

        <div className="space-y-4 pt-4">
          <h2 className="text-2xl font-bold text-orange-400">
            å…±æœ‰ãƒãƒ¼ãƒˆä¸€è¦§
          </h2>
          {notes.length === 0 ? (
            <p className="text-center text-slate-400">ã¾ã ãƒãƒ¼ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
          ) : (
            notes.map((note) => (
              <div key={note.id} className="p-4 bg-slate-700 rounded-xl shadow-md">
                <p className="text-slate-200 whitespace-pre-wrap">{note.content}</p>
                <div className="text-right text-xs text-slate-500 mt-2">
                  {new Date(note.timestamp).toLocaleString()}
                </div>
              </div>
            ))
          )}
        </div>
      </div>
    </div>
  );
};

export default App;
